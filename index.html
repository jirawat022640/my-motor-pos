<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Motor Shop POS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        body { padding: 20px; background-color: #f8f9fa; }
        #reader { width: 100%; max-width: 500px; margin: 0 auto; display: none; }
        .card { max-width: 500px; margin: 0 auto; }
    </style>
</head>
<body>

<div class="card shadow">
    <div class="card-header bg-primary text-white text-center">
        <h4>‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏≤‡∏¢‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô (Hard Mode)</h4>
    </div>
    <div class="card-body">
        
        <div id="reader"></div>
        <button class="btn btn-warning w-100 mb-3" onclick="startScan()">üì∑ ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏™‡πÅ‡∏Å‡∏ô</button>
        
        <div class="mb-3">
            <label>‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î:</label>
            <input type="text" id="barcodeInput" class="form-control" placeholder="‡∏¢‡∏¥‡∏á‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î ‡∏´‡∏£‡∏∑‡∏≠ ‡∏û‡∏¥‡∏°‡∏û‡πå...">
        </div>
        
        <div class="d-grid gap-2 mb-3">
            <button class="btn btn-success" onclick="searchProduct()">üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
        </div>

        <hr>

        <div id="productArea" style="display:none;">
            <h5 id="pName" class="text-primary"></h5>
            <p>‡∏£‡∏≤‡∏Ñ‡∏≤: <span id="pPrice" class="fw-bold"></span> ‡∏ö‡∏≤‡∏ó | ‡∏™‡∏ï‡πá‡∏≠‡∏Å: <span id="pStock"></span></p>
            
            <div class="row g-2 align-items-center mb-3">
                <div class="col-auto"><label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô:</label></div>
                <div class="col"><input type="number" id="qty" class="form-control" value="1"></div>
            </div>

            <button class="btn btn-primary w-100" onclick="saveOrder()">üí∞ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</button>
        </div>

    </div>
</div>

<script>
    // ----------------------------------------------------
    // ‚ö†Ô∏è ‡πÉ‡∏™‡πà URL ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ (‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å Apps Script)
    const APP_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxHHKOvaJAWxSAo-pQnvmnP7lLZn2G5_oeiFBK7aVdHY0RIGcsykLR9rWKvbfk98OE0iA/exec"; 
    // ----------------------------------------------------

    function startScan() {
        document.getElementById('reader').style.display = 'block';
        const html5QrCode = new Html5Qrcode("reader");
        html5QrCode.start(
            { facingMode: "environment" }, 
            { fps: 10, qrbox: { width: 250, height: 250 } },
            (decodedText, decodedResult) => {
                // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏à‡∏≠
                document.getElementById('barcodeInput').value = decodedText;
                html5QrCode.stop();
                document.getElementById('reader').style.display = 'none';
                searchProduct(); // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
            },
            (errorMessage) => { }
        ).catch(err => { console.log(err); });
    }

    function searchProduct() {
        let barcode = document.getElementById('barcodeInput').value;
        if(!barcode) return alert("‡∏Å‡∏£‡∏≠‡∏Å‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");

        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡πÑ‡∏õ‡∏ó‡∏µ‡πà Google Sheet
        fetch(APP_SCRIPT_URL + "?action=getProduct&barcode=" + barcode)
        .then(res => res.json())
        .then(data => {
            if(data.status == "success") {
                document.getElementById('productArea').style.display = 'block';
                document.getElementById('pName').innerText = data.name;
                document.getElementById('pPrice').innerText = data.price;
                document.getElementById('pStock').innerText = data.stock;
            } else {
                alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤!");
                document.getElementById('productArea').style.display = 'none';
            }
        });
    }

    function saveOrder() {
        let barcode = document.getElementById('barcodeInput').value;
        let name = document.getElementById('pName').innerText;
        let price = parseFloat(document.getElementById('pPrice').innerText);
        let qty = parseInt(document.getElementById('qty').value);
        let total = price * qty;

        let payload = {
            action: "saveOrder",
            barcode: barcode,
            name: name,
            qty: qty,
            total: total
        };

        // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (POST)
        fetch(APP_SCRIPT_URL, {
            method: "POST",
            body: JSON.stringify(payload)
        })
        .then(res => res.json())
        .then(data => {
            if(data.status == "saved") {
                alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß!");
                location.reload(); // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡∏≤‡∏¢‡∏ï‡πà‡∏≠
            }
        });
    }
</script>

</body>
</html>