<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MotoShop Pro POS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        body { background-color: #f0f2f5; padding-bottom: 80px; } /* ‡πÄ‡∏ß‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á */
        .scan-area { background: #333; color: white; padding: 10px; border-radius: 10px; text-align: center; margin-bottom: 10px;}
        #reader { width: 100%; border-radius: 8px; overflow: hidden; display: none; }
        .cart-item { background: white; border-bottom: 1px solid #eee; padding: 10px; }
        .cart-total { position: fixed; bottom: 0; left: 0; width: 100%; background: white; padding: 15px; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 1000; }
        .btn-float { position: fixed; bottom: 90px; right: 20px; border-radius: 50%; width: 60px; height: 60px; font-size: 24px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); z-index: 999; }
    </style>
</head>
<body>

<nav class="navbar navbar-dark bg-primary shadow-sm mb-3">
    <div class="container-fluid">
        <span class="navbar-brand mb-0 h1"><i class="bi bi-wrench-adjustable-circle"></i> ‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡πâ‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏°</span>
        <button class="btn btn-sm btn-light text-primary" onclick="syncData()">üîÑ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
    </div>
</nav>

<div class="container">
    
    <div class="scan-area" onclick="startScan()">
        <i class="bi bi-upc-scan" style="font-size: 2rem;"></i><br>
        ‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πÅ‡∏Å‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
        <div id="reader"></div>
    </div>

    <h6 class="text-muted ms-2 mt-3">‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (<span id="cartCount">0</span>)</h6>
    <div id="cartList" class="mb-5">
        <div class="text-center text-muted mt-5 p-5">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
    </div>

</div>

<button class="btn btn-warning btn-float shadow" onclick="openManualAdd()">
    <i class="bi bi-plus-lg"></i>
</button>

<div class="cart-total d-flex justify-content-between align-items-center">
    <div>
        <small class="text-muted">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</small>
        <h3 class="m-0 text-primary">‡∏ø<span id="grandTotal">0</span></h3>
    </div>
    <button class="btn btn-success btn-lg px-4" onclick="checkout()">
        <i class="bi bi-cash-coin"></i> ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô
    </button>
</div>

<div class="modal fade" id="manualModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏≠‡∏á / ‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
            <label>‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á, ‡∏ô‡πá‡∏≠‡∏ï)</label>
            <input type="text" id="mName" class="form-control" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠...">
        </div>
        <div class="row g-2">
            <div class="col">
                <label>‡∏£‡∏≤‡∏Ñ‡∏≤</label>
                <input type="number" id="mPrice" class="form-control" placeholder="0">
            </div>
            <div class="col">
                <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</label>
                <input type="number" id="mQty" class="form-control" value="1">
            </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary w-100" onclick="addManualItem()">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ö‡∏¥‡∏•</button>
      </div>
    </div>
  </div>
</div>

<script>
    // ----------------------------------------------------
    // ‚ö†Ô∏è ‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡πÅ‡∏Å‡πâ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏≠‡∏á‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö!
    const APP_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxHHKOvaJAWxSAo-pQnvmnP7lLZn2G5_oeiFBK7aVdHY0RIGcsykLR9rWKvbfk98OE0iA/exec"; 
    // ----------------------------------------------------

    let allProducts = []; // ‡πÄ‡∏Å‡πá‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á
    let cart = []; // ‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
    let html5QrCode;

    // ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    window.onload = function() {
        syncData();
    }

    function syncData() {
        fetch(APP_SCRIPT_URL + "?action=getAllProducts")
        .then(res => res.json())
        .then(json => {
            if(json.status == "success") {
                allProducts = json.data;
                console.log("Products Loaded:", allProducts.length);
                alert("‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô (" + allProducts.length + " ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)");
            }
        }).catch(err => alert("‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß"));
    }

    function startScan() {
        document.getElementById('reader').style.display = 'block';
        html5QrCode = new Html5Qrcode("reader");
        html5QrCode.start(
            { facingMode: "environment" }, 
            { fps: 10, qrbox: { width: 250, height: 250 } },
            (decodedText) => {
                html5QrCode.stop();
                document.getElementById('reader').style.display = 'none';
                findAndAdd(decodedText); // ‡πÄ‡∏à‡∏≠‡πÅ‡∏•‡πâ‡∏ß‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
            },
            (errorMessage) => { }
        ).catch(err => { console.log(err); });
    }

    function findAndAdd(barcode) {
        // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á (‡πÄ‡∏£‡πá‡∏ß‡∏°‡∏≤‡∏Å)
        let product = allProducts.find(p => p.barcode == barcode);
        
        if (product) {
            addToCart(product.name, product.price, 1, product.barcode, product.isService);
        } else {
            // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ ‡πÉ‡∏´‡πâ‡πÄ‡∏î‡πâ‡∏á‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á ‡πÅ‡∏ï‡πà‡πÉ‡∏™‡πà‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î‡∏£‡∏≠‡πÑ‡∏ß‡πâ
            if(confirm("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏´‡∏°?")) {
                openManualAdd(barcode);
            }
        }
    }

    function openManualAdd(barcodeObj = "") {
        const modal = new bootstrap.Modal(document.getElementById('manualModal'));
        document.getElementById('mName').value = barcodeObj ? "‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà (" + barcodeObj + ")" : "";
        document.getElementById('mPrice').value = "";
        document.getElementById('mQty').value = "1";
        modal.show();
    }

    function addManualItem() {
        let name = document.getElementById('mName').value;
        let price = parseFloat(document.getElementById('mPrice').value);
        let qty = parseInt(document.getElementById('mQty').value);

        if(!name || !price) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");

        addToCart(name, price, qty, "MANUAL", true); // Manual ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô Service ‡πÑ‡∏°‡πà‡∏ï‡∏±‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Å
        
        // ‡∏õ‡∏¥‡∏î Modal
        const modalEl = document.getElementById('manualModal');
        const modal = bootstrap.Modal.getInstance(modalEl);
        modal.hide();
    }

    function addToCart(name, price, qty, barcode, isService) {
        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏´‡∏° ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÉ‡∏´‡πâ‡∏ö‡∏ß‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°
        let existing = cart.find(item => item.barcode == barcode && item.barcode != "MANUAL");
        if (existing) {
            existing.qty += qty;
            existing.total = existing.qty * existing.price;
        } else {
            cart.push({
                barcode: barcode,
                name: name,
                price: price,
                qty: qty,
                total: price * qty,
                isService: isService
            });
        }
        renderCart();
    }

    function renderCart() {
        let list = document.getElementById('cartList');
        let total = 0;
        let count = 0;
        
        list.innerHTML = ""; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏≤

        cart.forEach((item, index) => {
            total += item.total;
            count += item.qty;

            let row = `
            <div class="cart-item d-flex justify-content-between align-items-center">
                <div>
                    <div class="fw-bold">${item.name}</div>
                    <small class="text-muted">${item.price} x ${item.qty} ${item.isService ? '(‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£)' : ''}</small>
                </div>
                <div class="text-end">
                    <div class="fw-bold text-primary">‡∏ø${item.total}</div>
                    <button class="btn btn-sm btn-outline-danger mt-1" onclick="removeFromCart(${index})"><i class="bi bi-trash"></i></button>
                </div>
            </div>`;
            list.innerHTML += row;
        });

        document.getElementById('grandTotal').innerText = total.toLocaleString();
        document.getElementById('cartCount').innerText = count;
        
        if(cart.length === 0) list.innerHTML = '<div class="text-center text-muted mt-5 p-5">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>';
    }

    function removeFromCart(index) {
        cart.splice(index, 1);
        renderCart();
    }

    function checkout() {
        if(cart.length == 0) return alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤");
        if(!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏¢‡∏≠‡∏î " + document.getElementById('grandTotal').innerText + " ‡∏ö‡∏≤‡∏ó?")) return;

        let payload = {
            action: "checkout",
            cart: cart
        };

        // ‡πÅ‡∏™‡∏î‡∏á Loading
        let payBtn = document.querySelector('.btn-success');
        let oldText = payBtn.innerHTML;
        payBtn.innerHTML = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";
        payBtn.disabled = true;

        fetch(APP_SCRIPT_URL, {
            method: "POST",
            body: JSON.stringify(payload)
        })
        .then(res => res.json())
        .then(data => {
            if(data.status == "saved") {
                alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢! ‡πÄ‡∏•‡∏Ç‡∏ö‡∏¥‡∏•: " + data.orderId);
                cart = []; // ‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤
                renderCart();
            } else {
                alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î");
            }
            payBtn.innerHTML = oldText;
            payBtn.disabled = false;
        })
        .catch(err => {
            alert("‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ");
            payBtn.innerHTML = oldText;
            payBtn.disabled = false;
        });
    }
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
